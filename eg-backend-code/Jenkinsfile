pipeline {
    agent any
    
    environment {
        PYTHON_VERSION = '3.11'
        VENV_NAME = 'elemental-genius-venv'
        // Jenkins credentials - configure these in Jenkins UI
        DB_HOST = credentials('db-host')
        DB_USER = credentials('db-user')
        DB_PASSWORD = credentials('db-password')
        SECRET_KEY = credentials('flask-secret-key')
        REDIS_URL = credentials('redis-url')
    }
    
    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }
        
        stage('Setup System Dependencies') {
            steps {
                script {
                    sh '''
                        # Install system dependencies for audio processing
                        sudo apt-get update
                        sudo apt-get install -y \
                            python3-dev \
                            python3-venv \
                            portaudio19-dev \
                            libasound2-dev \
                            libpulse-dev \
                            ffmpeg \
                            postgresql-client \
                            redis-tools
                    '''
                }
            }
        }
        
        stage('Setup Python Environment') {
            steps {
                sh '''
                    # Create virtual environment
                    python3 -m venv $VENV_NAME
                    source $VENV_NAME/bin/activate
                    
                    # Upgrade pip and install dependencies
                    pip install --upgrade pip
                    pip install -r requirements.txt
                '''
            }
        }
        
        stage('Database Setup') {
            steps {
                sh '''
                    source $VENV_NAME/bin/activate
                    
                    # Run database migrations
                    python database_setup.py
                '''
            }
        }
        
        stage('Run Tests') {
            steps {
                sh '''
                    source $VENV_NAME/bin/activate
                    
                    # Run pytest with coverage
                    pytest --cov=. --cov-report=xml --cov-report=html --junitxml=test-results.xml
                '''
            }
            post {
                always {
                    // Publish test results
                    publishTestResults testResultsPattern: 'test-results.xml'
                    publishCoverage adapters: [
                        coberturaAdapter('coverage.xml')
                    ], sourceFileResolver: sourceFiles('STORE_LAST_BUILD')
                }
            }
        }
        
        stage('Security Scan') {
            steps {
                sh '''
                    source $VENV_NAME/bin/activate
                    
                    # Install security scanning tools
                    pip install safety bandit
                    
                    # Check for known vulnerabilities
                    safety check
                    
                    # Run static security analysis
                    bandit -r . -f json -o bandit-report.json || true
                '''
            }
            post {
                always {
                    archiveArtifacts artifacts: 'bandit-report.json', allowEmptyArchive: true
                }
            }
        }
        
        stage('Deploy to Test') {
            when {
                branch 'main'
            }
            steps {
                script {
                    deployToEnvironment('test')
                }
            }
        }
        
        stage('Deploy to Production') {
            when {
                allOf {
                    branch 'main'
                    input message: 'Deploy to production?', ok: 'Deploy'
                }
            }
            steps {
                script {
                    deployToEnvironment('prod')
                }
            }
        }
    }
    
    post {
        always {
            // Clean up virtual environment
            sh 'rm -rf $VENV_NAME'
        }
        failure {
            emailext (
                subject: "Pipeline Failed: ${env.JOB_NAME} - ${env.BUILD_NUMBER}",
                body: "Build failed. Check console output at ${env.BUILD_URL}",
                to: "${env.CHANGE_AUTHOR_EMAIL ?: 'admin@elementalgenius.com'}"
            )
        }
    }
}

def deployToEnvironment(environment) {
    sh """
        # Create deployment package
        tar -czf elemental-genius-${environment}-${BUILD_NUMBER}.tar.gz \
            --exclude='.git' \
            --exclude='__pycache__' \
            --exclude='*.pyc' \
            --exclude='test_*' \
            --exclude='.pytest_cache' \
            --exclude='htmlcov' \
            .
        
        # Copy to target server (replace with your server details)
        scp elemental-genius-${environment}-${BUILD_NUMBER}.tar.gz \
            deploy@${environment}.elementalgenius.com:/opt/elemental-genius/
        
        # Deploy via SSH
        ssh deploy@${environment}.elementalgenius.com '''
            cd /opt/elemental-genius
            
            # Backup current deployment
            if [ -d current ]; then
                mv current backup-\$(date +%Y%m%d-%H%M%S)
            fi
            
            # Extract new deployment
            mkdir current
            tar -xzf elemental-genius-${environment}-${BUILD_NUMBER}.tar.gz -C current/
            
            # Setup virtual environment
            cd current
            python3 -m venv venv
            source venv/bin/activate
            pip install -r requirements.txt
            
            # Run database migrations
            python database_setup.py
            
            # Restart systemd service
            sudo systemctl restart elemental-genius-${environment}
            sudo systemctl status elemental-genius-${environment}
        '''
    """
}